<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Message Creator - Content Management System</title>
    
    <!-- CV Global Favicon Implementation -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="256x256" href="/static/favicon/favicon-256x256.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon/apple-touch-icon.png">
    <link rel="shortcut icon" href="/static/favicon.ico">
    <meta name="theme-color" content="#00ff88">
    <meta name="msapplication-TileColor" content="#000000">
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/cvglobal-theme.css">
    <style>
        .content-preview {
            background-color: var(--bs-gray-800);
            border-left: 4px solid var(--bs-primary);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.375rem;
        }
        .day-card {
            transition: transform 0.2s ease-in-out;
        }
        .day-card:hover {
            transform: translateY(-2px);
        }
        .content-status {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .cv-section-header {
            border-left: 4px solid #00ff88;
            padding-left: 15px;
            margin: 20px 0 15px 0;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="/static/favicon/cv-new-logo-favicon-32px.png" alt="CV Global Logo" class="me-2" style="width: 24px; height: 24px;">
                Daily Message Creator - Content Management System
            </a>
            <div class="navbar-nav flex-row">
                <a class="nav-link me-3" href="/dashboard">
                    <i class="fas fa-chart-line me-1"></i>Dashboard
                </a>
                {% if bot %}
                <a class="nav-link me-3" href="/bots">
                    <i class="fas fa-arrow-left me-1"></i>Back to Bot Management
                </a>
                {% else %}
                <a class="nav-link me-3" href="/bots">
                    <i class="fas fa-robot me-1"></i>Bot Management
                </a>
                {% endif %}
                <a class="nav-link me-3" href="/tags">
                    <i class="fas fa-tags me-1"></i>Tag Management
                </a>
                <a class="nav-link" href="/logout">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container">


        <!-- Content Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="cv-section-header">
                    <h2><i class="fas fa-book-open me-3 cv-text-primary"></i>Daily Content Management{% if bot %} - {{ bot.name }}{% endif %}</h2>
                    <p class="text-muted">Create and manage daily faith journey content{% if bot %} for bot: {{ bot.name }}{% endif %}, configure journey length, and track content statistics</p>
                </div>
                <div class="card cv-card">
                    <div class="card-header cv-bg-secondary d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 cv-text-primary"><i class="fas fa-calendar-alt me-2"></i><span id="journeyTitle">30-Day</span> Journey Overview</h5>
                        <div class="d-flex align-items-center gap-3">
                            <button class="btn btn-success btn-sm" id="aiGeneratedContentBtn">
                                <i class="fas fa-robot me-1"></i>Generate AI Content
                            </button>
                            <div class="form-group mb-0">
                                <label for="journeyDays" class="form-label mb-1 small">Journey Length:</label>
                                <select class="form-select form-select-sm" id="journeyDays">
                                    <option value="10">10 Days</option>
                                    <option value="30" selected>30 Days</option>
                                    <option value="60">60 Days</option>
                                    <option value="90">90 Days</option>
                                </select>
                            </div>
                            <button class="btn cv-btn-primary" id="addNewDayBtn">
                                <i class="fas fa-plus me-1"></i>Add Day
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row" id="daysOverview">
                            <!-- Days will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Content Editor Modal -->
        <div class="modal fade" id="contentModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-edit me-2"></i>
                            Edit Day <span id="modalDayNumber">1</span> Content
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="contentForm">
                            <input type="hidden" id="contentId" />
                            
                            <div class="mb-3">
                                <label for="dayNumber" class="form-label">Day Number</label>
                                <input type="number" class="form-control" id="dayNumber" min="1" max="30" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="title" class="form-label">Title</label>
                                <input type="text" class="form-control" id="title" placeholder="e.g., The Light of Hope" required>
                            </div>
                            
                            <!-- Multimedia Support -->
                            <div class="mb-3">
                                <label for="mediaType" class="form-label">
                                    <i class="fas fa-photo-video me-1"></i>Media Type
                                </label>
                                <select class="form-select" id="mediaType">
                                    <option value="text">üìÑ Text Only</option>
                                    <option value="image">üñºÔ∏è Image</option>
                                    <option value="video">üé• Video Upload</option>
                                    <option value="audio">üéµ Audio</option>
                                </select>
                            </div>
                            
                            <!-- Image Upload Section -->
                            <div id="imageSection" class="mb-3" style="display: none;">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-dark">
                                        <i class="fas fa-image me-2"></i>Image Upload
                                    </div>
                                    <div class="card-body">
                                        <!-- Upload New File Tab -->
                                        <ul class="nav nav-tabs mb-3" id="imageUploadTabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="upload-new-image-tab" data-bs-toggle="tab" data-bs-target="#upload-new-image" type="button" role="tab">
                                                    <i class="fas fa-upload me-1"></i>Upload New
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="choose-existing-image-tab" data-bs-toggle="tab" data-bs-target="#choose-existing-image" type="button" role="tab">
                                                    <i class="fas fa-folder-open me-1"></i>Choose Existing
                                                </button>
                                            </li>
                                        </ul>

                                        <div class="tab-content" id="imageUploadTabsContent">
                                            <!-- Upload New Tab -->
                                            <div class="tab-pane fade show active" id="upload-new-image" role="tabpanel">
                                                <input type="file" class="form-control" id="imageFile" accept="image/*">
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Supported formats: JPG, PNG, GIF (Max 16MB). Images will be displayed in the message.
                                                </div>
                                            </div>
                                            
                                            <!-- Choose Existing Tab -->
                                            <div class="tab-pane fade" id="choose-existing-image" role="tabpanel">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <label class="form-label mb-0">Select from existing images:</label>
                                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="loadMediaFilesModal('image')">
                                                        <i class="fas fa-sync-alt me-1"></i>Refresh
                                                    </button>
                                                </div>
                                                <div id="existingImagesContainer" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-spinner fa-spin"></i> Loading images...
                                                    </div>
                                                </div>
                                                <input type="hidden" id="selectedImageFile">
                                            </div>
                                        </div>
                                        <div id="imagePreview" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Video Upload Section -->
                            <div id="videoSection" class="mb-3" style="display: none;">
                                <div class="card border-danger">
                                    <div class="card-header bg-danger">
                                        <i class="fas fa-video me-2"></i>Video Content
                                    </div>
                                    <div class="card-body">
                                        <!-- Upload New File Tab -->
                                        <ul class="nav nav-tabs mb-3" id="videoUploadTabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="upload-new-video-tab" data-bs-toggle="tab" data-bs-target="#upload-new-video" type="button" role="tab">
                                                    <i class="fas fa-upload me-1"></i>Upload New
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="choose-existing-video-tab" data-bs-toggle="tab" data-bs-target="#choose-existing-video" type="button" role="tab">
                                                    <i class="fas fa-folder-open me-1"></i>Choose Existing
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="youtube-url-tab" data-bs-toggle="tab" data-bs-target="#youtube-url" type="button" role="tab">
                                                    <i class="fab fa-youtube me-1"></i>YouTube URL
                                                </button>
                                            </li>
                                        </ul>

                                        <div class="tab-content" id="videoUploadTabsContent">
                                            <!-- Upload New Tab -->
                                            <div class="tab-pane fade show active" id="upload-new-video" role="tabpanel">
                                                <input type="file" class="form-control" id="videoFile" accept="video/*">
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Supported formats: MP4, MOV, AVI (Max 100MB). Videos will be displayed in the message.
                                                </div>
                                            </div>
                                            
                                            <!-- Choose Existing Tab -->
                                            <div class="tab-pane fade" id="choose-existing-video" role="tabpanel">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <label class="form-label mb-0">Select from existing videos:</label>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="loadMediaFilesModal('video')">
                                                        <i class="fas fa-sync-alt me-1"></i>Refresh
                                                    </button>
                                                </div>
                                                <div id="existingVideosContainer" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-spinner fa-spin"></i> Loading videos...
                                                    </div>
                                                </div>
                                                <input type="hidden" id="selectedVideoFile">
                                            </div>
                                            
                                            <!-- YouTube URL Tab -->
                                            <div class="tab-pane fade" id="youtube-url" role="tabpanel">
                                                <label for="youtubeUrl" class="form-label">YouTube URL</label>
                                                <input type="url" class="form-control" id="youtubeUrl" placeholder="https://www.youtube.com/watch?v=VIDEO_ID">
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Enter the full YouTube URL. The video will be embedded in the message.
                                                </div>
                                            </div>
                                        </div>
                                        <div id="videoPreview" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Audio Upload Section -->
                            <div id="audioSection" class="mb-3" style="display: none;">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <i class="fas fa-volume-up me-2"></i>Audio Upload
                                    </div>
                                    <div class="card-body">
                                        <!-- Upload New File Tab -->
                                        <ul class="nav nav-tabs mb-3" id="audioUploadTabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="upload-new-audio-tab" data-bs-toggle="tab" data-bs-target="#upload-new-audio" type="button" role="tab">
                                                    <i class="fas fa-upload me-1"></i>Upload New
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="choose-existing-audio-tab" data-bs-toggle="tab" data-bs-target="#choose-existing-audio" type="button" role="tab">
                                                    <i class="fas fa-folder-open me-1"></i>Choose Existing
                                                </button>
                                            </li>
                                        </ul>

                                        <div class="tab-content" id="audioUploadTabsContent">
                                            <!-- Upload New Tab -->
                                            <div class="tab-pane fade show active" id="upload-new-audio" role="tabpanel">
                                                <input type="file" class="form-control" id="audioFile" accept="audio/*">
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Supported formats: MP3, WAV, OGG, M4A (Max 16MB). Great for prayers, music, or voice messages.
                                                </div>
                                            </div>
                                            
                                            <!-- Choose Existing Tab -->
                                            <div class="tab-pane fade" id="choose-existing-audio" role="tabpanel">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <label class="form-label mb-0">Select from existing audio files:</label>
                                                    <button type="button" class="btn btn-sm btn-outline-warning" onclick="loadMediaFilesModal('audio')">
                                                        <i class="fas fa-sync-alt me-1"></i>Refresh
                                                    </button>
                                                </div>
                                                <div id="existingAudioContainer" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-spinner fa-spin"></i> Loading audio files...
                                                    </div>
                                                </div>
                                                <input type="hidden" id="selectedAudioFile">
                                            </div>
                                        </div>
                                        <div id="audioPreview" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="content" class="form-label">Main Content Text</label>
                                <textarea class="form-control" id="content" rows="6" placeholder="Enter the main teaching content for this day..." required></textarea>
                                <div class="form-text">This text will accompany any multimedia content selected above.</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="reflectionQuestion" class="form-label">Reflection Question</label>
                                <textarea class="form-control" id="reflectionQuestion" rows="3" placeholder="e.g., How has light guided you through difficult times?" required></textarea>
                                <div class="form-text">A thoughtful question to encourage user reflection and response.</div>
                            </div>
                            
                            <div class="card mb-3 bg-dark">
                                <div class="card-header bg-secondary">
                                    <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Confirmation Button Customization</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="confirmationMessage" class="form-label">Confirmation Message</label>
                                        <textarea class="form-control" id="confirmationMessage" rows="2" placeholder="Leave blank for default. E.g., 'Have you read today's message?'"></textarea>
                                        <div class="form-text">Custom message asking if user has read the content. Leave blank to use default language-specific message.</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="yesButtonText" class="form-label">Yes Button Text</label>
                                                <input type="text" class="form-control" id="yesButtonText" placeholder="Leave blank for default. E.g., 'Yes, I've read it'">
                                                <div class="form-text">Custom text for the 'Yes' button. Leave blank to use default.</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="noButtonText" class="form-label">No Button Text</label>
                                                <input type="text" class="form-control" id="noButtonText" placeholder="Leave blank for default. E.g., 'Not yet'">
                                                <div class="form-text">Custom text for the 'No' button. Leave blank to use default.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="tags" class="form-label">Faith Journey Tags</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="tag_bible_exposure" value="Bible Exposure">
                                            <label class="form-check-label" for="tag_bible_exposure">Bible Exposure</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="tag_christian_learning" value="Christian Learning">
                                            <label class="form-check-label" for="tag_christian_learning">Christian Learning</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="tag_bible_engagement" value="Bible Engagement">
                                            <label class="form-check-label" for="tag_bible_engagement">Bible Engagement</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="tag_salvation_prayer" value="Salvation Prayer">
                                            <label class="form-check-label" for="tag_salvation_prayer">Salvation Prayer</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="tag_gospel_presentation" value="Gospel Presentation">
                                            <label class="form-check-label" for="tag_gospel_presentation">Gospel Presentation</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="tag_prayer" value="Prayer">
                                            <label class="form-check-label" for="tag_prayer">Prayer</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="tag_introduction_to_jesus" value="Introduction to Jesus">
                                            <label class="form-check-label" for="tag_introduction_to_jesus">Introduction to Jesus</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="tag_holy_spirit_empowerment" value="Holy Spirit Empowerment">
                                            <label class="form-check-label" for="tag_holy_spirit_empowerment">Holy Spirit Empowerment</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-text">Select relevant tags for this day's content focus.</div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isActive">
                                    <label class="form-check-label" for="isActive">
                                        Active (will be sent to users)
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <h6>Content Preview:</h6>
                                <div class="content-preview" id="contentPreview">
                                    Preview will appear here as you type...
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger me-auto" id="deleteButton" style="display: none;">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                        <button type="button" class="btn btn-primary" id="saveContentBtn">
                            <i class="fas fa-save me-1"></i>Save Content
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Cache Buster: Updated 2025-09-18 -->
    <script>
        let contentModal;
        let allContent = [];
        let greetingContent = null;

        document.addEventListener('DOMContentLoaded', function() {
            contentModal = new bootstrap.Modal(document.getElementById('contentModal'));
            loadAllContent();
            loadGreetingContent();
            
            // Real-time preview
            ['title', 'content', 'reflectionQuestion', 'youtubeUrl'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updatePreview);
                }
            });
            
            // Add event listeners for tag checkboxes
            document.querySelectorAll('input[type="checkbox"][id^="tag_"]').forEach(checkbox => {
                checkbox.addEventListener('change', updatePreview);
            });
            
            // Media type change listener
            document.getElementById('mediaType').addEventListener('change', function() {
                toggleMediaSections();
                updatePreview();
            });
            
            // Add event listeners for journey days selector
            document.getElementById('journeyDays').addEventListener('change', updateJourneyLength);
            
            // Add event listeners for buttons
            document.getElementById('addNewDayBtn').addEventListener('click', addNewDay);
            document.getElementById('saveContentBtn').addEventListener('click', saveContent);
            document.getElementById('deleteButton').addEventListener('click', deleteContent);
            document.getElementById('aiGeneratedContentBtn').addEventListener('click', function() {
                {% if bot %}
                window.location.href = '/bots/{{ bot.id }}/ai-content-generation';
                {% else %}
                window.location.href = '/cms/ai-content-generation';
                {% endif %}
            });
            
            // Add event listeners for file inputs
            document.getElementById('imageFile').addEventListener('change', updatePreview);
            document.getElementById('videoFile').addEventListener('change', updatePreview);
            document.getElementById('audioFile').addEventListener('change', updatePreview);
            
            // Add event delegation for card clicks
            document.getElementById('daysOverview').addEventListener('click', function(e) {
                const card = e.target.closest('[data-action]');
                if (card) {
                    const action = card.dataset.action;
                    if (action === 'edit-greeting') {
                        editGreeting();
                    } else if (action === 'edit-day') {
                        const dayNumber = parseInt(card.dataset.day);
                        editDay(dayNumber);
                    }
                }
            });
        });

        function loadAllContent() {
            let url = '/api/content?content_type=daily';
            {% if bot %}
            url += '&bot_id={{ bot.id }}';
            {% endif %}
            
            fetch(url)
                .then(response => {
                    console.log('Content API response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Loaded daily content:', data);
                    console.log('Content count:', data.length);
                    allContent = data;
                    displayDaysOverview();
                })
                .catch(error => {
                    console.error('Error loading content:', error);
                    showAlert('Error loading content: ' + error.message, 'danger');
                });
        }

        // Duplicate function removed

        function loadGreetingContent() {
            let url = '/api/content?content_type=greeting';
            {% if bot %}
            url += '&bot_id={{ bot.id }}';
            {% endif %}
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    greetingContent = data.length > 0 ? data[0] : null;
                    displayDaysOverview(); // Refresh the display to include greeting
                })
                .catch(error => {
                    console.error('Error loading greeting content:', error);
                    greetingContent = null;
                    displayDaysOverview(); // Refresh even on error
                });
        }

        function editGreeting() {
            let url = '/api/content?content_type=greeting';
            {% if bot %}
            url += '&bot_id={{ bot.id }}';
            {% endif %}
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const greeting = data.length > 0 ? data[0] : null;
                    
                    document.getElementById('modalDayNumber').textContent = 'Welcome';
                    document.getElementById('contentId').value = greeting ? greeting.id : '';
                    document.getElementById('dayNumber').value = 0; // Use 0 for greeting
                    document.getElementById('title').value = greeting ? greeting.title || 'Welcome Message' : 'Welcome Message';
                    document.getElementById('content').value = greeting ? greeting.content || '' : `Welcome to your Faith Journey! üì±

You'll receive daily content for the next 10 days (every 10 minutes for testing). After each piece of content, I'll ask you a simple reflection question.

Available Commands:
‚Ä¢ /start - Begin or restart journey
‚Ä¢ /stop - Unsubscribe from messages  
‚Ä¢ /help - Show help message
‚Ä¢ /human - Chat directly with a human

Day 1 content will arrive in 10 seconds!`;
                    document.getElementById('reflectionQuestion').value = ''; // No reflection for greeting
                    document.getElementById('isActive').checked = greeting ? greeting.is_active : true;
                    
                    // Set multimedia type from database (or default to text for new greeting)
                    document.getElementById('mediaType').value = greeting ? (greeting.media_type || 'text') : 'text';
                    
                    // Handle existing media files for greeting
                    if (greeting) {
                        // Clear any previous file inputs and preview containers
                        document.getElementById('imageFile').value = '';
                        document.getElementById('videoFile').value = '';
                        document.getElementById('audioFile').value = '';
                        document.getElementById('imagePreview').innerHTML = '';
                        document.getElementById('videoPreview').innerHTML = '';
                        document.getElementById('audioPreview').innerHTML = '';
                        
                        // Show existing media if present - using secure DOM manipulation
                        if (greeting.media_type === 'video' && greeting.video_filename) {
                            const videoPreview = document.getElementById('videoPreview');
                            const container = document.createElement('div');
                            container.className = 'mt-2';
                            
                            const title = document.createElement('strong');
                            title.textContent = '‚úì Current video: ';
                            const filename = document.createElement('span');
                            filename.textContent = greeting.video_filename;
                            
                            const videoContainer = document.createElement('div');
                            videoContainer.className = 'mt-2';
                            const video = document.createElement('video');
                            video.controls = true;
                            video.style.cssText = 'max-width: 100%; max-height: 300px; border-radius: 0.375rem;';
                            video.preload = 'none';
                            const source = document.createElement('source');
                            source.src = `/static/uploads/videos/${greeting.video_filename}`;
                            source.type = 'video/mp4';
                            video.appendChild(source);
                            video.textContent = 'Your browser does not support the video element.';
                            videoContainer.appendChild(video);
                            
                            container.appendChild(title);
                            container.appendChild(filename);
                            container.appendChild(videoContainer);
                            videoPreview.appendChild(container);
                        } else if (greeting.media_type === 'image' && greeting.image_filename) {
                            const imagePreview = document.getElementById('imagePreview');
                            const container = document.createElement('div');
                            container.className = 'mt-2';
                            
                            const title = document.createElement('strong');
                            title.textContent = '‚úì Current image: ';
                            const filename = document.createElement('span');
                            filename.textContent = greeting.image_filename;
                            
                            const imageContainer = document.createElement('div');
                            imageContainer.className = 'mt-2';
                            const img = document.createElement('img');
                            img.src = `/static/uploads/images/${greeting.image_filename}`;
                            img.className = 'img-thumbnail';
                            img.style.cssText = 'max-width: 100%; max-height: 300px;';
                            imageContainer.appendChild(img);
                            
                            container.appendChild(title);
                            container.appendChild(filename);
                            container.appendChild(imageContainer);
                            imagePreview.appendChild(container);
                        } else if (greeting.media_type === 'audio' && greeting.audio_filename) {
                            const audioPreview = document.getElementById('audioPreview');
                            const container = document.createElement('div');
                            container.className = 'mt-2';
                            
                            const title = document.createElement('strong');
                            title.textContent = '‚úì Current audio: ';
                            const filename = document.createElement('span');
                            filename.textContent = greeting.audio_filename;
                            
                            const audioContainer = document.createElement('div');
                            audioContainer.className = 'mt-2';
                            const audio = document.createElement('audio');
                            audio.controls = true;
                            audio.style.cssText = 'width: 100%; max-width: 400px;';
                            audio.preload = 'none';
                            const source = document.createElement('source');
                            source.src = `/static/uploads/audio/${greeting.audio_filename}`;
                            source.type = 'audio/mpeg';
                            audio.appendChild(source);
                            audio.textContent = 'Your browser does not support the audio element.';
                            audioContainer.appendChild(audio);
                            
                            container.appendChild(title);
                            container.appendChild(filename);
                            container.appendChild(audioContainer);
                            audioPreview.appendChild(container);
                        }
                    }
                    
                    // Set tags - greeting should have Introduction to Jesus tag
                    setSelectedTags(greeting ? greeting.tags : ['Introduction to Jesus (ITJ)']);
                    
                    document.getElementById('deleteButton').style.display = greeting ? 'block' : 'none';
                    
                    toggleMediaSections();
                    updatePreview();
                    contentModal.show();
                })
                .catch(error => {
                    console.error('Error loading greeting content:', error);
                    showAlert('Error loading greeting content: ' + error.message, 'danger');
                });
        }

        let currentJourneyDays = 30;

        function updateJourneyLength() {
            currentJourneyDays = parseInt(document.getElementById('journeyDays').value);
            document.getElementById('journeyTitle').textContent = `${currentJourneyDays}-Day`;
            displayDaysOverview();
        }

        function displayDaysOverview() {
            const container = document.getElementById('daysOverview');
            container.innerHTML = '';
            
            console.log('displayDaysOverview called');
            console.log('currentJourneyDays:', currentJourneyDays);
            console.log('allContent length:', allContent.length);
            console.log('greetingContent:', greetingContent);
            
            // First, add the welcome message card
            const welcomeCard = document.createElement('div');
            welcomeCard.className = 'col-md-3 col-sm-4 col-6 mb-3';
            const hasGreeting = greetingContent && greetingContent.content;
            welcomeCard.innerHTML = `
                <div class="card day-card h-100 ${hasGreeting ? 'border-primary' : 'border-secondary'}" 
                     data-action="edit-greeting" style="cursor: pointer; position: relative;">
                    <div class="content-status">
                        ${hasGreeting ? 
                            '<span class="badge bg-primary"><i class="fas fa-handshake"></i></span>' : 
                            '<span class="badge bg-secondary"><i class="fas fa-plus"></i></span>'
                        }
                    </div>
                    <div class="card-body d-flex flex-column">
                        <h6 class="card-title">
                            üëã Welcome
                        </h6>
                        <p class="card-text flex-grow-1 small">
                            ${hasGreeting ? 
                                `<strong>${greetingContent.title || 'Welcome Message'}</strong><br>
                                 <span class="text-muted">${(greetingContent.content || '').substring(0, 35)}...</span>` : 
                                '<span class="text-muted">Click to add welcome message</span>'
                            }
                        </p>
                    </div>
                </div>
            `;
            container.appendChild(welcomeCard);
            
            // Create day cards based on selected journey length
            for (let day = 1; day <= currentJourneyDays; day++) {
                const dayContent = allContent.find(c => c.day_number === day);
                const hasContent = dayContent && dayContent.content;
                const isActive = dayContent ? dayContent.is_active : false;
                const tags = dayContent?.tags || [];
                const mediaType = dayContent?.media_type || 'text';
                
                // Media type icon with upload status
                let mediaIcon = 'üìÑ';
                let uploadStatus = '';
                if (mediaType === 'image') {
                    mediaIcon = 'üñºÔ∏è';
                    uploadStatus = dayContent?.image_filename ? ' ‚úì' : '';
                } else if (mediaType === 'video') {
                    mediaIcon = 'üé•';
                    uploadStatus = dayContent?.video_filename ? ' ‚úì' : (dayContent?.youtube_url ? ' (YT)' : '');
                } else if (mediaType === 'audio') {
                    mediaIcon = 'üéµ';
                    uploadStatus = dayContent?.audio_filename ? ' ‚úì' : '';
                }
                
                const card = document.createElement('div');
                card.className = 'col-md-3 col-sm-4 col-6 mb-3';
                card.innerHTML = `
                    <div class="card day-card h-100 ${hasContent ? 'border-success' : 'border-secondary'}" 
                         data-action="edit-day" data-day="${day}" style="cursor: pointer; position: relative;">
                        <div class="content-status">
                            ${hasContent ? 
                                `<span class="badge ${isActive ? 'bg-success' : 'bg-warning'}">
                                    <i class="fas ${isActive ? 'fa-check' : 'fa-pause'}"></i>
                                </span>` : 
                                '<span class="badge bg-secondary"><i class="fas fa-plus"></i></span>'
                            }
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title">
                                ${mediaIcon}${uploadStatus} Day ${day}
                            </h6>
                            <p class="card-text flex-grow-1 small">
                                ${hasContent ? 
                                    `<strong>${dayContent.title || 'Untitled'}</strong><br>
                                     <span class="text-muted">${(dayContent.content || '').substring(0, 35)}...</span>
                                     ${tags.length > 0 ? `<br><small class="text-info">${tags.slice(0, 2).join(', ')}${tags.length > 2 ? '...' : ''}</small>` : ''}` : 
                                    '<span class="text-muted">Click to add content</span>'
                                }
                            </p>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            }
        }

        function editDay(dayNumber) {
            const dayContent = allContent.find(c => c.day_number === dayNumber);
            
            document.getElementById('modalDayNumber').textContent = dayNumber;
            document.getElementById('contentId').value = dayContent ? dayContent.id : '';
            document.getElementById('dayNumber').value = dayNumber;
            document.getElementById('title').value = dayContent ? dayContent.title || '' : '';
            document.getElementById('content').value = dayContent ? dayContent.content || '' : '';
            document.getElementById('reflectionQuestion').value = dayContent ? dayContent.reflection_question || '' : '';
            document.getElementById('confirmationMessage').value = dayContent ? (dayContent.confirmation_message || '') : '';
            document.getElementById('yesButtonText').value = dayContent ? (dayContent.yes_button_text || '') : '';
            document.getElementById('noButtonText').value = dayContent ? (dayContent.no_button_text || '') : '';
            document.getElementById('isActive').checked = dayContent ? dayContent.is_active : true;
            
            // Set multimedia type
            const mediaType = dayContent?.media_type || 'text';
            document.getElementById('mediaType').value = mediaType;
            
            // Clear multimedia fields when switching media types
            document.getElementById('videoFile').value = '';
            document.getElementById('imageFile').value = '';
            document.getElementById('audioFile').value = '';
            
            // Clear preview containers
            document.getElementById('videoPreview').innerHTML = '';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('audioPreview').innerHTML = '';
            
            // Show existing uploaded files if available
            if (dayContent) {
                if (mediaType === 'video' && dayContent.video_filename) {
                    document.getElementById('videoPreview').innerHTML = `
                        <div class="alert alert-success mt-2">
                            <strong>‚úì Current video:</strong> ${dayContent.video_filename}
                            <div class="mt-2">
                                <video controls style="max-width: 100%; max-height: 200px;" class="rounded">
                                    <source src="/static/uploads/videos/${dayContent.video_filename}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                            <small class="text-muted d-block mt-1">Upload a new video to replace this one</small>
                        </div>
                    `;
                } else if (mediaType === 'image' && dayContent.image_filename) {
                    document.getElementById('imagePreview').innerHTML = `
                        <div class="alert alert-success mt-2">
                            <strong>‚úì Current image:</strong> ${dayContent.image_filename}
                            <div class="mt-2">
                                <img src="/static/uploads/images/${dayContent.image_filename}" 
                                     class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                            </div>
                            <small class="text-muted d-block mt-1">Upload a new image to replace this one</small>
                        </div>
                    `;
                } else if (mediaType === 'audio' && dayContent.audio_filename) {
                    document.getElementById('audioPreview').innerHTML = `
                        <div class="alert alert-success mt-2">
                            <strong>‚úì Current audio:</strong> ${dayContent.audio_filename}
                            <div class="mt-2">
                                <audio controls class="w-100">
                                    <source src="/static/uploads/audio/${dayContent.audio_filename}" type="audio/mpeg">
                                    Your browser does not support the audio tag.
                                </audio>
                            </div>
                            <small class="text-muted d-block mt-1">Upload a new audio file to replace this one</small>
                        </div>
                    `;
                }
            }
            
            // Set tags
            setSelectedTags(dayContent ? dayContent.tags : []);
            
            document.getElementById('deleteButton').style.display = dayContent ? 'block' : 'none';
            
            toggleMediaSections();
            updatePreview();
            contentModal.show();
        }

        function addNewDay() {
            // Find next available day
            const usedDays = allContent.map(c => c.day_number);
            let nextDay = 1;
            while (usedDays.includes(nextDay) && nextDay <= currentJourneyDays) {
                nextDay++;
            }
            
            if (nextDay > currentJourneyDays) {
                showAlert(`All ${currentJourneyDays} days already have content!`, 'warning');
                return;
            }
            
            editDay(nextDay);
        }

        function updatePreview() {
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const question = document.getElementById('reflectionQuestion').value;
            const selectedTags = getSelectedTags();
            const mediaType = document.getElementById('mediaType').value;
            const dayNumber = parseInt(document.getElementById('dayNumber').value);
            
            let preview = '';
            
            // Get the appropriate content - check greeting content for day 0, otherwise use allContent
            const dayContent = dayNumber === 0 ? greetingContent : allContent.find(c => c.day_number === dayNumber);
            
            // Media preview
            if (mediaType === 'image') {
                const imageFile = document.getElementById('imageFile').files[0];
                
                if (imageFile) {
                    preview += `<div class="mb-3">
                        <span class="badge bg-info">üñºÔ∏è New Image Upload</span><br>
                        <small class="text-muted">${imageFile.name} (${(imageFile.size / (1024*1024)).toFixed(1)}MB)</small>
                        <div class="mt-2">
                            <img src="${URL.createObjectURL(imageFile)}" class="img-thumbnail" style="max-width: 100%; max-height: 200px;">
                        </div>
                    </div>`;
                } else if (dayContent && dayContent.image_filename) {
                    preview += `<div class="mb-3">
                        <span class="badge bg-success">üñºÔ∏è Current Image</span><br>
                        <small class="text-muted">${dayContent.image_filename}</small>
                        <div class="mt-2">
                            <img src="/static/uploads/images/${dayContent.image_filename}" class="img-thumbnail" style="max-width: 100%; max-height: 200px;">
                        </div>
                    </div>`;
                } else {
                    preview += `<div class="mb-2"><span class="badge bg-info">üñºÔ∏è Image Content</span></div>`;
                }
            } else if (mediaType === 'video') {
                const videoFile = document.getElementById('videoFile').files[0];
                
                if (videoFile) {
                    preview += `<div class="mb-3">
                        <span class="badge bg-danger">üé• New Video Upload</span><br>
                        <small class="text-muted">${videoFile.name} (${(videoFile.size / (1024*1024)).toFixed(1)}MB)</small>
                        <div class="mt-2">
                            <video controls style="max-width: 100%; max-height: 200px;" class="rounded">
                                <source src="${URL.createObjectURL(videoFile)}" type="${videoFile.type}">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    </div>`;
                } else if (dayContent && dayContent.video_filename) {
                    preview += `<div class="mb-3">
                        <span class="badge bg-success">üé• Current Video</span><br>
                        <small class="text-muted">${dayContent.video_filename}</small>
                        <div class="mt-2">
                            <video controls style="max-width: 100%; max-height: 200px;" class="rounded">
                                <source src="/static/uploads/videos/${dayContent.video_filename}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    </div>`;
                } else {
                    preview += `<div class="mb-2"><span class="badge bg-danger">üé• Video Content</span></div>`;
                }
            } else if (mediaType === 'audio') {
                const audioFile = document.getElementById('audioFile').files[0];
                
                if (audioFile) {
                    preview += `<div class="mb-3">
                        <span class="badge bg-warning text-dark">üéµ New Audio Upload</span><br>
                        <small class="text-muted">${audioFile.name} (${(audioFile.size / (1024*1024)).toFixed(1)}MB)</small>
                        <div class="mt-2">
                            <audio controls class="w-100">
                                <source src="${URL.createObjectURL(audioFile)}" type="${audioFile.type}">
                                Your browser does not support the audio tag.
                            </audio>
                        </div>
                    </div>`;
                } else if (dayContent && dayContent.audio_filename) {
                    preview += `<div class="mb-3">
                        <span class="badge bg-success text-white">üéµ Current Audio</span><br>
                        <small class="text-muted">${dayContent.audio_filename}</small>
                        <div class="mt-2">
                            <audio controls class="w-100">
                                <source src="/static/uploads/audio/${dayContent.audio_filename}" type="audio/mpeg">
                                Your browser does not support the audio tag.
                            </audio>
                        </div>
                    </div>`;
                } else {
                    preview += `<div class="mb-2"><span class="badge bg-warning text-dark">üéµ Audio Content</span></div>`;
                }
            }
            
            if (title) preview += `<strong>üìñ ${title}</strong><br><br>`;
            if (content) preview += `${content.replace(/\n/g, '<br>')}<br><br>`;
            if (question) preview += `<strong>ü§î Reflection:</strong><br>${question.replace(/\n/g, '<br>')}`;
            if (selectedTags.length > 0) {
                preview += `<br><br><small><strong>Tags:</strong> ${selectedTags.map(tag => `<span class="badge bg-primary">${tag}</span>`).join(' ')}</small>`;
            }
            
            document.getElementById('contentPreview').innerHTML = preview || 'Preview will appear here as you type...';
        }

        function getSelectedTags() {
            const tags = [];
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="tag_"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    tags.push(checkbox.value);
                }
            });
            return tags;
        }

        function setSelectedTags(tags) {
            // Clear all checkboxes first
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="tag_"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Set selected tags
            if (tags && tags.length > 0) {
                tags.forEach(tag => {
                    const checkbox = document.querySelector(`input[value="${tag}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }
        }

        function saveContent() {
            // Basic validation
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const reflectionQuestion = document.getElementById('reflectionQuestion').value;
            const dayNumber = document.getElementById('dayNumber').value;
            
            // Greeting content doesn't require reflection question
            const isGreeting = parseInt(dayNumber) === 0;
            if (!title || !content || (!isGreeting && !reflectionQuestion) || !dayNumber) {
                showAlert('Please fill in all required fields', 'warning');
                return;
            }
            
            const formData = new FormData();
            
            // Basic content fields
            const contentId = document.getElementById('contentId').value;
            if (contentId) formData.append('id', contentId);
            
            formData.append('day_number', dayNumber);
            formData.append('title', title);
            formData.append('content', content);
            formData.append('reflection_question', reflectionQuestion);
            formData.append('tags', JSON.stringify(getSelectedTags()));
            formData.append('is_active', document.getElementById('isActive').checked);
            
            // Add confirmation button customization
            formData.append('confirmation_message', document.getElementById('confirmationMessage').value);
            formData.append('yes_button_text', document.getElementById('yesButtonText').value);
            formData.append('no_button_text', document.getElementById('noButtonText').value);
            
            // Add content_type for greeting content
            formData.append('content_type', isGreeting ? 'greeting' : 'daily');
            
            // Add bot_id if this is bot-specific content management
            {% if bot %}
            formData.append('bot_id', '{{ bot.id }}');
            {% endif %}
            
            // Multimedia fields
            const mediaType = document.getElementById('mediaType').value;
            formData.append('media_type', mediaType);
            
            if (mediaType === 'image') {
                const imageFile = document.getElementById('imageFile').files[0];
                if (imageFile) {
                    formData.append('image_file', imageFile);
                } else {
                    // Include selected existing image if no new upload
                    const selectedImage = document.getElementById('selectedImageFile')?.value;
                    if (selectedImage) {
                        formData.append('selected_image', selectedImage);
                    }
                }
            } else if (mediaType === 'video') {
                const videoFile = document.getElementById('videoFile').files[0];
                if (videoFile) {
                    formData.append('video_file', videoFile);
                } else {
                    // Include selected existing video if no new upload
                    const selectedVideo = document.getElementById('selectedVideoFile')?.value;
                    if (selectedVideo) {
                        formData.append('selected_video', selectedVideo);
                    }
                }
            } else if (mediaType === 'audio') {
                const audioFile = document.getElementById('audioFile').files[0];
                if (audioFile) {
                    formData.append('audio_file', audioFile);
                } else {
                    // Include selected existing audio if no new upload
                    const selectedAudio = document.getElementById('selectedAudioFile')?.value;
                    if (selectedAudio) {
                        formData.append('selected_audio', selectedAudio);
                    }
                }
            }
            
            // Use the multimedia content creation/editing endpoint
            const url = contentId ? `/cms/content/edit/${contentId}` : '/cms/content/create';
            
            fetch(url, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    const isGreeting = parseInt(dayNumber) === 0;
                    showAlert(`${isGreeting ? 'Welcome message' : 'Day ' + dayNumber + ' content'} saved successfully!`, 'success');
                    contentModal.hide();
                    if (isGreeting) {
                        setTimeout(() => loadGreetingContent(), 500);
                    }
                    setTimeout(() => loadAllContent(), 500);
                } else {
                    return response.text().then(text => {
                        throw new Error(text || 'Failed to save content');
                    });
                }
            })
            .catch(error => {
                console.error('Save error:', error);
                showAlert('Error saving content: ' + error.message, 'danger');
            });
        }

        function deleteContent() {
            const contentId = document.getElementById('contentId').value;
            const dayNumber = document.getElementById('dayNumber').value;
            
            if (!contentId) return;
            
            if (!confirm(`Are you sure you want to delete Day ${dayNumber} content? This cannot be undone.`)) {
                return;
            }
            
            fetch(`/api/content/${contentId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showAlert(`Day ${dayNumber} content deleted successfully!`, 'success');
                    contentModal.hide();
                    loadAllContent();
                } else {
                    showAlert('Error deleting content: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                showAlert('Error deleting content: ' + error.message, 'danger');
            });
        }

        function toggleMediaSections() {
            const mediaType = document.getElementById('mediaType').value;
            const imageSection = document.getElementById('imageSection');
            const videoSection = document.getElementById('videoSection');
            const audioSection = document.getElementById('audioSection');
            
            // Hide all sections
            imageSection.style.display = 'none';
            videoSection.style.display = 'none';
            audioSection.style.display = 'none';
            
            // Clear all file inputs and previews when switching
            document.getElementById('imageFile').value = '';
            document.getElementById('videoFile').value = '';
            document.getElementById('audioFile').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('videoPreview').innerHTML = '';
            document.getElementById('audioPreview').innerHTML = '';
            
            // Show selected section
            if (mediaType === 'image') {
                imageSection.style.display = 'block';
            } else if (mediaType === 'video') {
                videoSection.style.display = 'block';
            } else if (mediaType === 'audio') {
                audioSection.style.display = 'block';
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Media Files Modal Management Functions
        async function loadMediaFilesModal(mediaType) {
            const containerId = mediaType === 'image' ? 'existingImagesContainer' : 
                               mediaType === 'video' ? 'existingVideosContainer' : 'existingAudioContainer';
            const container = document.getElementById(containerId);
            
            if (!container) return;
            
            // Show loading state
            container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Loading ' + mediaType + ' files...</div>';
            
            // Get bot_id if available
            let botId = null;
            {% if bot %}
            botId = {{ bot.id }};
            {% endif %}
            
            try {
                const url = `/api/media/browse?media_type=${mediaType}${botId ? '&bot_id=' + botId : ''}`;
                const response = await fetch(url, {
                    method: 'GET',
                    credentials: 'same-origin',  // Include session cookies for authentication
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.files && data.files.length > 0) {
                    let html = '<div class="row g-2">';
                    
                    data.files.forEach(file => {
                        const cardClass = '';
                        
                        if (mediaType === 'image') {
                            html += `
                                <div class="col-md-4 col-sm-6">
                                    <div class="card ${cardClass} media-file-card" 
                                         style="cursor: pointer;" 
                                         onclick="selectMediaFileModal('${file.filename}', '${mediaType}', this)">
                                        <img src="${file.url}" class="card-img-top" style="height: 120px; object-fit: cover;">
                                        <div class="card-body p-2">
                                            <small class="text-muted d-block text-truncate" title="${file.display_name}">
                                                ${file.display_name}
                                            </small>
                                            <small class="text-muted">
                                                ${file.size_display} ‚Ä¢ ${file.modified_display}
                                            </small>
                                            ${file.bot_id ? `<span class="badge bg-secondary">Bot ${file.bot_id}</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (mediaType === 'video') {
                            html += `
                                <div class="col-md-6">
                                    <div class="card ${cardClass} media-file-card" 
                                         style="cursor: pointer;" 
                                         onclick="selectMediaFileModal('${file.filename}', '${mediaType}', this)">
                                        <div class="card-body p-3">
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="me-3">
                                                    <i class="fas fa-file-video fa-2x text-danger"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="fw-bold text-truncate" title="${file.display_name}">
                                                        ${file.display_name}
                                                    </div>
                                                    <small class="text-muted">
                                                        ${file.size_display} ‚Ä¢ ${file.modified_display}
                                                    </small>
                                                    ${file.bot_id ? `<br><span class="badge bg-secondary">Bot ${file.bot_id}</span>` : ''}
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <video controls style="width: 100%; max-width: 300px; border-radius: 0.375rem;" preload="none">
                                                    <source src="${file.url}" type="video/mp4">
                                                    Your browser does not support the video element.
                                                </video>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (mediaType === 'audio') {
                            html += `
                                <div class="col-md-6">
                                    <div class="card ${cardClass} media-file-card" 
                                         style="cursor: pointer;" 
                                         onclick="selectMediaFileModal('${file.filename}', '${mediaType}', this)">
                                        <div class="card-body p-3">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <i class="fas fa-file-audio fa-2x text-warning"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="fw-bold text-truncate" title="${file.display_name}">
                                                        ${file.display_name}
                                                    </div>
                                                    <small class="text-muted">
                                                        ${file.size_display} ‚Ä¢ ${file.modified_display}
                                                    </small>
                                                    ${file.bot_id ? `<br><span class="badge bg-secondary">Bot ${file.bot_id}</span>` : ''}
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <audio controls style="width: 100%; max-width: 300px;" preload="none">
                                                    <source src="${file.url}" type="audio/mpeg">
                                                </audio>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-folder-open fa-3x mb-3"></i>
                            <div>No ${mediaType} files found</div>
                            <small>Upload some ${mediaType} files first to see them here</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading media files:', error);
                container.innerHTML = `
                    <div class="text-center text-danger py-4">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <div>Error loading files</div>
                        <small>Please try again</small>
                    </div>
                `;
            }
        }

        // Select media file function for modal
        function selectMediaFileModal(filename, mediaType, element) {
            // Remove selection from other cards
            const cards = element.closest('.row').querySelectorAll('.media-file-card');
            cards.forEach(card => {
                card.classList.remove('border-primary', 'border-2');
            });
            
            // Add selection to clicked card
            element.classList.add('border-primary', 'border-2');
            
            // Set hidden input value
            const inputId = mediaType === 'image' ? 'selectedImageFile' : 
                           mediaType === 'video' ? 'selectedVideoFile' : 'selectedAudioFile';
            const hiddenInput = document.getElementById(inputId);
            if (hiddenInput) {
                hiddenInput.value = filename;
            }
            
            // Clear file input since we're using existing file
            const fileInputId = mediaType === 'image' ? 'imageFile' : 
                              mediaType === 'video' ? 'videoFile' : 'audioFile';
            const fileInput = document.getElementById(fileInputId);
            if (fileInput) {
                fileInput.value = '';
            }
            
            // Update preview
            updatePreview();
        }
    </script>
</body>
</html>