<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - Daily Message Creator CMS</title>
    <!-- CV Global Favicon Implementation -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="256x256" href="/static/favicon/favicon-256x256.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon/apple-touch-icon.png">
    <link rel="shortcut icon" href="/static/favicon.ico">
    <meta name="theme-color" content="#00ff88">
    <meta name="msapplication-TileColor" content="#000000">
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/cvglobal-theme.css">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="/cms">
                <img src="/static/favicon/cv-new-logo-favicon-32px.png" alt="CV Global Logo" class="me-2" style="width: 24px; height: 24px;">
                {{ title }}
            </a>
            <div class="navbar-nav flex-row">
                <a class="nav-link me-3" href="/">
                    <i class="fas fa-chart-line me-1"></i>Dashboard
                </a>
                <a class="nav-link me-3" href="/cms">
                    <i class="fas fa-edit me-1"></i>Back to CMS
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card cv-card">
                    <div class="card-header cv-bg-secondary">
                        <h4 class="mb-0 cv-text-primary">
                            <i class="fas fa-photo-video me-2"></i>{{ title }}
                        </h4>
                    </div>
                    <div class="card-body">
                        <form method="POST" enctype="multipart/form-data" id="contentForm">
                            {{ form.hidden_tag() }}
                            
                            <!-- Hidden inputs for selected existing media files - at form level for proper submission -->
                            <input type="hidden" name="selected_image" id="selectedImageFile">
                            <input type="hidden" name="selected_video" id="selectedVideoFile">
                            <input type="hidden" name="selected_audio" id="selectedAudioFile">
                            
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        {{ form.day_number.label(class="form-label") }}
                                        {{ form.day_number(class="form-control") }}
                                        {% if form.day_number.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.day_number.errors[0] }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-9">
                                    <div class="mb-3">
                                        {{ form.title.label(class="form-label") }}
                                        {{ form.title(class="form-control", placeholder="Enter a compelling title for this day's content") }}
                                        {% if form.title.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.title.errors[0] }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                {{ form.media_type.label(class="form-label") }}
                                {{ form.media_type(class="form-select", id="mediaType") }}
                                <div class="form-text">
                                    Select the primary media type for this content. You can include text with any media type.
                                </div>
                                {% if form.media_type.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.media_type.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Image Upload Section -->
                            <div id="imageSection" class="mb-3" style="display: none;">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-dark">
                                        <i class="fas fa-image me-2"></i>Image Upload
                                    </div>
                                    <div class="card-body">
                                        <!-- Upload New File Tab -->
                                        <ul class="nav nav-tabs mb-3" id="imageUploadTabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="upload-new-image-tab" data-bs-toggle="tab" data-bs-target="#upload-new-image" type="button" role="tab">
                                                    <i class="fas fa-upload me-1"></i>Upload New
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="choose-existing-image-tab" data-bs-toggle="tab" data-bs-target="#choose-existing-image" type="button" role="tab">
                                                    <i class="fas fa-folder-open me-1"></i>Choose Existing
                                                </button>
                                            </li>
                                        </ul>

                                        <div class="tab-content" id="imageUploadTabsContent">
                                            <!-- Upload New Tab -->
                                            <div class="tab-pane fade show active" id="upload-new-image" role="tabpanel">
                                                {{ form.image_file.label(class="form-label") }}
                                                {{ form.image_file(class="form-control", accept="image/*") }}
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Supported formats: JPG, PNG, GIF (Max 16MB). Images will be displayed in the message.
                                                </div>
                                            </div>
                                            
                                            <!-- Choose Existing Tab -->
                                            <div class="tab-pane fade" id="choose-existing-image" role="tabpanel">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <label class="form-label mb-0">Select from existing images:</label>
                                                    <button type="button" class="btn btn-sm btn-outline-info" id="refreshImageBtn">
                                                        <i class="fas fa-sync-alt me-1"></i>Refresh
                                                    </button>
                                                </div>
                                                <div id="existingImagesContainer" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-spinner fa-spin"></i> Loading images...
                                                    </div>
                                                </div>
                                                <!-- Preview area for selected image -->
                                                <div id="selectedImagePreview" class="mt-3" style="display: none;">
                                                    <small class="text-muted">Selected image:</small><br>
                                                    <img id="selectedImagePreviewImg" class="img-thumbnail mt-2" style="max-width: 300px; max-height: 200px;">
                                                </div>
                                            </div>
                                        </div>

                                        {% if content and content.image_filename %}
                                            <div class="mt-3">
                                                <small class="text-muted">Current image:</small><br>
                                                <img src="{{ url_for('uploaded_file', filename='images/' + content.image_filename) }}" 
                                                     class="img-thumbnail mt-2" style="max-width: 300px; max-height: 200px;">
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Video Upload Section -->
                            <div id="videoSection" class="mb-3" style="display: none;">
                                <div class="card border-danger">
                                    <div class="card-header bg-danger">
                                        <i class="fas fa-video me-2"></i>Video Content
                                    </div>
                                    <div class="card-body">
                                        <!-- Upload New File Tab -->
                                        <ul class="nav nav-tabs mb-3" id="videoUploadTabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="upload-new-video-tab" data-bs-toggle="tab" data-bs-target="#upload-new-video" type="button" role="tab">
                                                    <i class="fas fa-upload me-1"></i>Upload New
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="choose-existing-video-tab" data-bs-toggle="tab" data-bs-target="#choose-existing-video" type="button" role="tab">
                                                    <i class="fas fa-folder-open me-1"></i>Choose Existing
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="youtube-url-tab" data-bs-toggle="tab" data-bs-target="#youtube-url" type="button" role="tab">
                                                    <i class="fab fa-youtube me-1"></i>YouTube URL
                                                </button>
                                            </li>
                                        </ul>

                                        <div class="tab-content" id="videoUploadTabsContent">
                                            <!-- Upload New Tab -->
                                            <div class="tab-pane fade show active" id="upload-new-video" role="tabpanel">
                                                <label for="video_file" class="form-label">Upload Video File</label>
                                                <input type="file" class="form-control" name="video_file" id="video_file" accept="video/*">
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Supported formats: MP4, MOV, AVI (Max 100MB). Videos will be displayed in the message.
                                                </div>
                                            </div>
                                            
                                            <!-- Choose Existing Tab -->
                                            <div class="tab-pane fade" id="choose-existing-video" role="tabpanel">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <label class="form-label mb-0">Select from existing videos:</label>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" id="refreshVideoBtn">
                                                        <i class="fas fa-sync-alt me-1"></i>Refresh
                                                    </button>
                                                </div>
                                                <div id="existingVideosContainer" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-spinner fa-spin"></i> Loading videos...
                                                    </div>
                                                </div>
                                                <!-- Preview area for selected video -->
                                                <div id="selectedVideoPreview" class="mt-3" style="display: none;">
                                                    <small class="text-muted">Selected video:</small><br>
                                                    <video id="selectedVideoPreviewVid" controls class="mt-2" style="max-width: 400px; width: 100%; border-radius: 0.375rem;">
                                                        Your browser does not support the video element.
                                                    </video>
                                                </div>
                                            </div>
                                            
                                            <!-- YouTube URL Tab -->
                                            <div class="tab-pane fade" id="youtube-url" role="tabpanel">
                                                {{ form.youtube_url.label(class="form-label") }}
                                                {{ form.youtube_url(class="form-control", placeholder="https://www.youtube.com/watch?v=VIDEO_ID") }}
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Enter the full YouTube URL. The video will be embedded in the message.
                                                </div>
                                                {% if form.youtube_url.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.youtube_url.errors[0] }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        {% if content and content.video_filename %}
                                            <div class="mt-3">
                                                <small class="text-muted">Current video:</small><br>
                                                <video controls class="mt-2" style="max-width: 400px; width: 100%; border-radius: 0.375rem;">
                                                    <source src="{{ url_for('uploaded_file', filename='videos/' + content.video_filename) }}" type="video/mp4">
                                                    Your browser does not support the video element.
                                                </video>
                                            </div>
                                        {% elif content and content.youtube_url %}
                                            <div class="mt-3">
                                                <small class="text-muted">Current video:</small><br>
                                                {% set video_id = content.youtube_url.split('v=')[1].split('&')[0] if 'v=' in content.youtube_url %}
                                                {% if video_id %}
                                                    <div class="ratio ratio-16x9 mt-2" style="max-width: 400px;">
                                                        <iframe src="https://www.youtube.com/embed/{{ video_id }}" 
                                                                allowfullscreen style="border-radius: 0.375rem;"></iframe>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Audio Upload Section -->
                            <div id="audioSection" class="mb-3" style="display: none;">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <i class="fas fa-volume-up me-2"></i>Audio Upload
                                    </div>
                                    <div class="card-body">
                                        <!-- Upload New File Tab -->
                                        <ul class="nav nav-tabs mb-3" id="audioUploadTabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="upload-new-audio-tab" data-bs-toggle="tab" data-bs-target="#upload-new-audio" type="button" role="tab">
                                                    <i class="fas fa-upload me-1"></i>Upload New
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="choose-existing-audio-tab" data-bs-toggle="tab" data-bs-target="#choose-existing-audio" type="button" role="tab">
                                                    <i class="fas fa-folder-open me-1"></i>Choose Existing
                                                </button>
                                            </li>
                                        </ul>

                                        <div class="tab-content" id="audioUploadTabsContent">
                                            <!-- Upload New Tab -->
                                            <div class="tab-pane fade show active" id="upload-new-audio" role="tabpanel">
                                                {{ form.audio_file.label(class="form-label") }}
                                                {{ form.audio_file(class="form-control", accept="audio/*") }}
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Supported formats: MP3, WAV, OGG, M4A (Max 16MB). Great for prayers, music, or voice messages.
                                                </div>
                                            </div>
                                            
                                            <!-- Choose Existing Tab -->
                                            <div class="tab-pane fade" id="choose-existing-audio" role="tabpanel">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <label class="form-label mb-0">Select from existing audio files:</label>
                                                    <button type="button" class="btn btn-sm btn-outline-warning" id="refreshAudioBtn">
                                                        <i class="fas fa-sync-alt me-1"></i>Refresh
                                                    </button>
                                                </div>
                                                <div id="existingAudioContainer" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-spinner fa-spin"></i> Loading audio files...
                                                    </div>
                                                </div>
                                                <!-- Preview area for selected audio -->
                                                <div id="selectedAudioPreview" class="mt-3" style="display: none;">
                                                    <small class="text-muted">Selected audio:</small><br>
                                                    <audio id="selectedAudioPreviewAud" controls class="mt-2" style="max-width: 400px; width: 100%;">
                                                        Your browser does not support the audio element.
                                                    </audio>
                                                </div>
                                            </div>
                                        </div>

                                        {% if content and content.audio_filename %}
                                            <div class="mt-3">
                                                <small class="text-muted">Current audio:</small><br>
                                                <audio controls class="mt-2" style="max-width: 400px; width: 100%;">
                                                    <source src="{{ url_for('uploaded_file', filename='audio/' + content.audio_filename) }}" type="audio/mpeg">
                                                    Your browser does not support the audio element.
                                                </audio>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                {{ form.content.label(class="form-label") }}
                                {{ form.content(class="form-control", rows="6", 
                                   placeholder="Enter the main text content for this day. This will accompany any multimedia content you've selected above.") }}
                                <div class="form-text">
                                    This text will be sent along with your multimedia content. Make it engaging and relevant to the faith journey.
                                </div>
                                {% if form.content.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.content.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                {{ form.reflection_question.label(class="form-label") }}
                                {{ form.reflection_question(class="form-control", rows="3", 
                                   placeholder="Enter a thoughtful reflection question that will be sent after the main content.") }}
                                <div class="form-text">
                                    This question will be sent a few minutes after the main content to encourage user reflection and engagement.
                                </div>
                                {% if form.reflection_question.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.reflection_question.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                {{ form.tags.label(class="form-label") }}
                                {{ form.tags(class="form-control", 
                                   placeholder="Bible Exposure, Christian Learning, Prayer, Gospel Presentation") }}
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Separate tags with commas. Available: Bible Exposure, Christian Learning, Bible Engagement, 
                                    Salvation Prayer, Gospel Presentation, Prayer, Introduction to Jesus, Holy Spirit Empowerment
                                </div>
                                {% if form.tags.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.tags.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-4">
                                <div class="form-check">
                                    {{ form.is_active(class="form-check-input") }}
                                    {{ form.is_active.label(class="form-check-label") }}
                                    <div class="form-text">
                                        Only active content will be delivered to users. Inactive content is saved as draft.
                                    </div>
                                </div>
                            </div>

                            <!-- AI Content Generation Section -->
                            <div class="card border-success mb-4">
                                <div class="card-header bg-success">
                                    <h6 class="mb-0"><i class="fas fa-robot me-2"></i>AI Content Generation</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            {{ form.enable_ai_content_generation(class="form-check-input", id="enableAIGeneration") }}
                                            {{ form.enable_ai_content_generation.label(class="form-check-label") }}
                                            <div class="form-text">
                                                Use AI to automatically generate content for your bot's journey
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="aiGenerationSettings" style="display: none;">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                {{ form.content_generation_duration.label(class="form-label") }}
                                                {{ form.content_generation_duration(class="form-select") }}
                                                {% if form.content_generation_duration.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.content_generation_duration.errors[0] }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6">
                                                {{ form.audience_language.label(class="form-label") }}
                                                {{ form.audience_language(class="form-select") }}
                                                <div class="form-text">{{ form.audience_language.description }}</div>
                                                {% if form.audience_language.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.audience_language.errors[0] }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                {{ form.target_audience.label(class="form-label") }}
                                                {{ form.target_audience(class="form-control") }}
                                                <div class="form-text">{{ form.target_audience.description }}</div>
                                                {% if form.target_audience.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.target_audience.errors[0] }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-4">
                                                {{ form.audience_religion.label(class="form-label") }}
                                                {{ form.audience_religion(class="form-control") }}
                                                <div class="form-text">{{ form.audience_religion.description }}</div>
                                                {% if form.audience_religion.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.audience_religion.errors[0] }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-4">
                                                {{ form.audience_age_group.label(class="form-label") }}
                                                {{ form.audience_age_group(class="form-control") }}
                                                <div class="form-text">{{ form.audience_age_group.description }}</div>
                                                {% if form.audience_age_group.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.audience_age_group.errors[0] }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            {{ form.content_generation_prompt.label(class="form-label") }}
                                            {{ form.content_generation_prompt(class="form-control", rows="4") }}
                                            <div class="form-text">{{ form.content_generation_prompt.description }}</div>
                                            {% if form.content_generation_prompt.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.content_generation_prompt.errors[0] }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Content Preview Section -->
                            <div class="card border-info mb-4">
                                <div class="card-header bg-info">
                                    <h6 class="mb-0">
                                        <i class="fas fa-eye me-2"></i>Content Preview:
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <!-- Media Preview Area -->
                                    <div id="mainContentPreview" class="mb-3">
                                        <!-- Selected media will be displayed here -->
                                    </div>
                                    
                                    <!-- Text Content Preview -->
                                    <div id="textContentPreview" class="mt-3">
                                        <!-- Text content will be shown here -->
                                    </div>
                                    
                                    <small class="text-muted">
                                        This text will accompany any multimedia content selected above.
                                    </small>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <a href="{{ url_for('cms') }}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Back to CMS
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>{{ "Update Content" if content else "Create Content" }}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ CMS Content Form JavaScript loaded');
        
        // Add global error handler to catch silent JS errors
        window.addEventListener('error', function(e) {
            console.error('üö® JavaScript Error:', e.error, 'at', e.filename + ':' + e.lineno);
        });
        
        const mediaTypeSelect = document.getElementById('mediaType');
        const imageSection = document.getElementById('imageSection');
        const videoSection = document.getElementById('videoSection');
        const audioSection = document.getElementById('audioSection');
        
        function toggleSections() {
            const selectedType = mediaTypeSelect.value;
            
            imageSection.style.display = selectedType === 'image' ? 'block' : 'none';
            videoSection.style.display = selectedType === 'video' ? 'block' : 'none';
            audioSection.style.display = selectedType === 'audio' ? 'block' : 'none';
            
            // Load media files when section becomes visible
            if (selectedType === 'image') {
                setTimeout(() => loadMediaFiles('image'), 100);
            } else if (selectedType === 'video') {
                setTimeout(() => loadMediaFiles('video'), 100);
            } else if (selectedType === 'audio') {
                setTimeout(() => loadMediaFiles('audio'), 100);
            }
        }
        
        mediaTypeSelect.addEventListener('change', toggleSections);
        toggleSections(); // Initialize on page load
        
        // Handle AI generation toggle
        const aiGenerationCheckbox = document.getElementById('enableAIGeneration');
        const aiGenerationSettings = document.getElementById('aiGenerationSettings');
        
        function toggleAISettings() {
            if (aiGenerationCheckbox && aiGenerationSettings) {
                aiGenerationSettings.style.display = aiGenerationCheckbox.checked ? 'block' : 'none';
            }
        }
        
        if (aiGenerationCheckbox) {
            aiGenerationCheckbox.addEventListener('change', toggleAISettings);
            toggleAISettings(); // Initialize on page load
        }
        
        // Add automatic refresh when clicking "Choose Existing" tabs
        const chooseExistingImageTab = document.getElementById('choose-existing-image-tab');
        const chooseExistingVideoTab = document.getElementById('choose-existing-video-tab');
        const chooseExistingAudioTab = document.getElementById('choose-existing-audio-tab');
        
        // Prevent duplicate loading with a simple guard
        const loadingStates = new Set();
        
        function guardedLoadMediaFiles(mediaType) {
            const key = `loading-${mediaType}`;
            if (loadingStates.has(key)) {
                console.log(`${mediaType} files already loading, skipping duplicate request`);
                return;
            }
            loadingStates.add(key);
            loadMediaFiles(mediaType).finally(() => {
                loadingStates.delete(key);
            });
        }
        
        if (chooseExistingImageTab) {
            console.log('‚úÖ Image tab element found, attaching listener...');
            chooseExistingImageTab.addEventListener('shown.bs.tab', function(e) {
                console.log('üîÑ Image tab shown event fired, loading files...');
                setTimeout(() => guardedLoadMediaFiles('image'), 100);
            });
        } else {
            console.log('‚ùå Image tab element not found');
        }
        
        if (chooseExistingVideoTab) {
            console.log('‚úÖ Video tab element found, attaching listener...');
            chooseExistingVideoTab.addEventListener('shown.bs.tab', function(e) {
                console.log('üîÑ Video tab shown event fired, loading files...');
                setTimeout(() => guardedLoadMediaFiles('video'), 100);
            });
        } else {
            console.log('‚ùå Video tab element not found');
        }
        
        if (chooseExistingAudioTab) {
            console.log('‚úÖ Audio tab element found, attaching listener...');
            chooseExistingAudioTab.addEventListener('shown.bs.tab', function(e) {
                console.log('üîÑ Audio tab shown event fired, loading files...');
                setTimeout(() => guardedLoadMediaFiles('audio'), 100);
            });
        } else {
            console.log('‚ùå Audio tab element not found');
        }

        // Add event listeners for manual refresh buttons
        const refreshImageBtn = document.getElementById('refreshImageBtn');
        const refreshVideoBtn = document.getElementById('refreshVideoBtn');
        const refreshAudioBtn = document.getElementById('refreshAudioBtn');
        
        if (refreshImageBtn) {
            refreshImageBtn.addEventListener('click', function() {
                console.log('üîÑ Image refresh button clicked');
                loadMediaFiles('image');
            });
        }
        
        if (refreshVideoBtn) {
            refreshVideoBtn.addEventListener('click', function() {
                console.log('üîÑ Video refresh button clicked');
                loadMediaFiles('video');
            });
        }
        
        if (refreshAudioBtn) {
            refreshAudioBtn.addEventListener('click', function() {
                console.log('üîÑ Audio refresh button clicked');
                loadMediaFiles('audio');
            });
        }

        // Generate safe URL from filename and media type
        function createSafeMediaUrl(filename, mediaType) {
            if (!filename || typeof filename !== 'string') {
                console.warn('Invalid filename provided:', filename);
                return null;
            }
            
            const folder = mediaType === 'image' ? 'images' : 
                          mediaType === 'video' ? 'videos' : 
                          mediaType === 'audio' ? 'audio' : null;
            
            if (!folder) {
                console.warn('Invalid media type:', mediaType);
                return null;
            }
            
            // Create safe URL from trusted filename - no path traversal possible
            return `/static/uploads/${folder}/${encodeURIComponent(filename)}`;
        }
        
        // Enhanced URL sanitization function with double-encoding protection
        function sanitizeMediaUrl(url, mediaType) {
            if (!url || typeof url !== 'string') {
                console.warn('Invalid URL provided:', url);
                return null;
            }
            
            try {
                // Normalize the URL to prevent path traversal attacks
                const normalizedUrl = new URL(url, location.origin);
                let pathname = normalizedUrl.pathname;
                
                // Iteratively decode to handle double-encoding attacks
                let previousPath = '';
                let attempts = 0;
                while (pathname !== previousPath && attempts < 5) {
                    previousPath = pathname;
                    try {
                        pathname = decodeURIComponent(pathname);
                    } catch (e) {
                        console.warn('Malformed URL encoding:', url);
                        return null;
                    }
                    attempts++;
                }
                
                // Reject any path with traversal patterns after full decoding
                if (pathname.includes('../') || pathname.includes('%') || url.toLowerCase().includes('%2e')) {
                    console.warn('Path traversal or encoding attempt detected:', url);
                    return null;
                }
                
                // Only allow same-origin URLs starting with /static/uploads/
                if (!pathname.startsWith('/static/uploads/')) {
                    console.warn('URL must start with /static/uploads/, rejecting:', pathname);
                    return null;
                }
                
                // Validate the path matches the expected media type folder
                const expectedFolder = mediaType === 'image' ? 'images' : 
                                      mediaType === 'video' ? 'videos' : 
                                      mediaType === 'audio' ? 'audio' : null;
                
                if (expectedFolder && !pathname.startsWith(`/static/uploads/${expectedFolder}/`)) {
                    console.warn(`URL path does not match expected folder for ${mediaType}:`, pathname);
                    return null;
                }
                
                return pathname; // Return the sanitized pathname
            } catch (e) {
                console.warn('Invalid URL format:', url, e);
                return null;
            }
        }

        // Load media files function  
        async function loadMediaFiles(mediaType) {
            const containerId = mediaType === 'image' ? 'existingImagesContainer' : 
                               mediaType === 'video' ? 'existingVideosContainer' : 'existingAudioContainer';
            const container = document.getElementById(containerId);
            
            if (!container) return;
            
            // Show loading state
            container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Loading ' + mediaType + ' files...</div>';
        
            
            // Get bot_id from the form if available
            const botIdInput = document.querySelector('input[name="bot_id"]') || document.querySelector('select[name="bot_id"]');
            const botId = botIdInput ? botIdInput.value : null;
            
            try {
                const url = `/api/media/browse?media_type=${mediaType}${botId ? '&bot_id=' + botId : ''}`;
                const response = await fetch(url);
                const data = await response.json();
            
                
                if (data.success && data.files && data.files.length > 0) {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'row g-2';
                
                    
                    data.files.forEach(file => {
                        const isSelected = false; // Could check against current file
                        const cardClass = isSelected ? 'border-primary' : '';
                        
                        if (mediaType === 'image') {
                        const colDiv = document.createElement('div');
                        colDiv.className = 'col-md-4 col-sm-6';
                        
                        const cardDiv = document.createElement('div');
                        cardDiv.className = `card ${cardClass} media-file-card`;
                        cardDiv.style.cursor = 'pointer';
                        cardDiv.addEventListener('click', () => selectMediaFile(file.filename, mediaType, cardDiv));
                        
                        const img = document.createElement('img');
                        const sanitizedUrl = sanitizeMediaUrl(file.url, mediaType);
                        if (sanitizedUrl) {
                            img.src = sanitizedUrl;
                        } else {
                            continue; // Skip this file if URL is invalid
                        }
                        img.className = 'card-img-top';
                        img.style.height = '120px';
                        img.style.objectFit = 'cover';
                        
                        const cardBody = document.createElement('div');
                        cardBody.className = 'card-body p-2';
                        
                        const titleSmall = document.createElement('small');
                        titleSmall.className = 'text-muted d-block text-truncate';
                        titleSmall.title = file.display_name;
                        titleSmall.textContent = file.display_name; // Safe text content
                        
                        const metaSmall = document.createElement('small');
                        metaSmall.className = 'text-muted';
                        metaSmall.textContent = `${file.size_display} ‚Ä¢ ${file.modified_display}`;
                        
                        cardBody.appendChild(titleSmall);
                        cardBody.appendChild(metaSmall);
                        
                        if (file.bot_id) {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-secondary';
                            badge.textContent = `Bot ${file.bot_id}`;
                            cardBody.appendChild(badge);
                        }
                        
                        cardDiv.appendChild(img);
                        cardDiv.appendChild(cardBody);
                        colDiv.appendChild(cardDiv);
                        rowDiv.appendChild(colDiv);
                        
                    } else if (mediaType === 'video') {
                        const colDiv = document.createElement('div');
                        colDiv.className = 'col-md-6';
                        
                        const cardDiv = document.createElement('div');
                        cardDiv.className = `card ${cardClass} media-file-card`;
                        cardDiv.style.cursor = 'pointer';
                        cardDiv.addEventListener('click', () => selectMediaFile(file.filename, mediaType, cardDiv));
                        
                        const cardBody = document.createElement('div');
                        cardBody.className = 'card-body p-3';
                        
                        const flexDiv = document.createElement('div');
                        flexDiv.className = 'd-flex align-items-center mb-2';
                        
                        const iconDiv = document.createElement('div');
                        iconDiv.className = 'me-3';
                        iconDiv.innerHTML = '<i class="fas fa-file-video fa-2x text-danger"></i>';
                        
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'flex-grow-1';
                        
                        const titleDiv = document.createElement('div');
                        titleDiv.className = 'fw-bold text-truncate';
                        titleDiv.title = file.display_name;
                        titleDiv.textContent = file.display_name;
                        
                        const metaSmall = document.createElement('small');
                        metaSmall.className = 'text-muted';
                        metaSmall.textContent = `${file.size_display} ‚Ä¢ ${file.modified_display}`;
                        
                        contentDiv.appendChild(titleDiv);
                        contentDiv.appendChild(metaSmall);
                        
                        if (file.bot_id) {
                            const br = document.createElement('br');
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-secondary';
                            badge.textContent = `Bot ${file.bot_id}`;
                            contentDiv.appendChild(br);
                            contentDiv.appendChild(badge);
                        }
                        
                        flexDiv.appendChild(iconDiv);
                        flexDiv.appendChild(contentDiv);
                        
                        const videoDiv = document.createElement('div');
                        videoDiv.className = 'mt-2';
                        
                        const video = document.createElement('video');
                        video.controls = true;
                        video.style.width = '100%';
                        video.style.maxWidth = '300px';
                        video.style.borderRadius = '0.375rem';
                        video.preload = 'none';
                        
                        const source = document.createElement('source');
                        const sanitizedUrl = sanitizeMediaUrl(file.url, mediaType);
                        if (sanitizedUrl) {
                            source.src = sanitizedUrl;
                        } else {
                            continue; // Skip this file if URL is invalid
                        }
                        source.type = 'video/mp4';
                        
                        video.appendChild(source);
                        video.appendChild(document.createTextNode('Your browser does not support the video element.'));
                        videoDiv.appendChild(video);
                        
                        cardBody.appendChild(flexDiv);
                        cardBody.appendChild(videoDiv);
                        cardDiv.appendChild(cardBody);
                        colDiv.appendChild(cardDiv);
                        rowDiv.appendChild(colDiv);
                        
                    } else if (mediaType === 'audio') {
                        const colDiv = document.createElement('div');
                        colDiv.className = 'col-md-6';
                        
                        const cardDiv = document.createElement('div');
                        cardDiv.className = `card ${cardClass} media-file-card`;
                        cardDiv.style.cursor = 'pointer';
                        cardDiv.addEventListener('click', () => selectMediaFile(file.filename, mediaType, cardDiv));
                        
                        const cardBody = document.createElement('div');
                        cardBody.className = 'card-body p-3';
                        
                        const flexDiv = document.createElement('div');
                        flexDiv.className = 'd-flex align-items-center';
                        
                        const iconDiv = document.createElement('div');
                        iconDiv.className = 'me-3';
                        iconDiv.innerHTML = '<i class="fas fa-file-audio fa-2x text-warning"></i>';
                        
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'flex-grow-1';
                        
                        const titleDiv = document.createElement('div');
                        titleDiv.className = 'fw-bold text-truncate';
                        titleDiv.title = file.display_name;
                        titleDiv.textContent = file.display_name;
                        
                        const metaSmall = document.createElement('small');
                        metaSmall.className = 'text-muted';
                        metaSmall.textContent = `${file.size_display} ‚Ä¢ ${file.modified_display}`;
                        
                        contentDiv.appendChild(titleDiv);
                        contentDiv.appendChild(metaSmall);
                        
                        if (file.bot_id) {
                            const br = document.createElement('br');
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-secondary';
                            badge.textContent = `Bot ${file.bot_id}`;
                            contentDiv.appendChild(br);
                            contentDiv.appendChild(badge);
                        }
                        
                        flexDiv.appendChild(iconDiv);
                        flexDiv.appendChild(contentDiv);
                        
                        const audioDiv = document.createElement('div');
                        audioDiv.className = 'mt-2';
                        
                        const audio = document.createElement('audio');
                        audio.controls = true;
                        audio.style.width = '100%';
                        audio.style.maxWidth = '300px';
                        audio.preload = 'none';
                        
                        const source = document.createElement('source');
                        const sanitizedUrl = sanitizeMediaUrl(file.url, mediaType);
                        if (sanitizedUrl) {
                            source.src = sanitizedUrl;
                        } else {
                            continue; // Skip this file if URL is invalid
                        }
                        source.type = 'audio/mpeg';
                        
                        audio.appendChild(source);
                        audioDiv.appendChild(audio);
                        
                        cardBody.appendChild(flexDiv);
                        cardBody.appendChild(audioDiv);
                        cardDiv.appendChild(cardBody);
                        colDiv.appendChild(cardDiv);
                        rowDiv.appendChild(colDiv);
                    }
                });
                
                container.innerHTML = '';
                container.appendChild(rowDiv);
            } else {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-folder-open fa-3x mb-3"></i>
                        <div>No ${mediaType} files found</div>
                        <small>Upload some ${mediaType} files first to see them here</small>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading media files:', error);
            container.innerHTML = `
                <div class="text-center text-danger py-4">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <div>Error loading files</div>
                    <small>Please try again</small>
                </div>
            `;
        }
    }

    // Select media file function - creates safe URL from filename
    function selectMediaFile(filename, mediaType, element) {
        console.log(`üéØ selectMediaFile called: filename="${filename}", mediaType="${mediaType}"`);
        
        // Defensive: ensure element is valid, try to find it if missing
        if (!element) {
            console.warn(`‚ö†Ô∏è Element not provided, trying to find card for ${filename}`);
            element = document.querySelector(`[data-filename="${filename}"]`) || 
                     document.querySelector('.media-file-card.border-primary');
        }
        
        if (!element) {
            console.error(`‚ùå Cannot find element for ${filename}, aborting selection`);
            return;
        }
        
        // Remove selection from other cards in this container
        const container = element.closest('.row') || element.parentElement;
        if (container) {
            const cards = container.querySelectorAll('.media-file-card');
            cards.forEach(card => {
                card.classList.remove('border-primary', 'border-2');
            });
        }
        
        // Add selection to clicked card
        element.classList.add('border-primary', 'border-2');
        
        // Set hidden input value with filename only (not URL)
        const inputId = mediaType === 'image' ? 'selectedImageFile' : 
                       mediaType === 'video' ? 'selectedVideoFile' : 'selectedAudioFile';
        console.log(`üîç Looking for hidden input with ID: ${inputId}`);
        
        const hiddenInput = document.getElementById(inputId);
        if (hiddenInput) {
            hiddenInput.value = filename;
            console.log(`‚úÖ Hidden input found and set: ${inputId} = "${filename}"`);
            console.log(`üîç Hidden input details: name="${hiddenInput.name}", value="${hiddenInput.value}"`);
        } else {
            console.error(`‚ùå Hidden input NOT found: ${inputId}`);
            // Debug: List all inputs in the form
            const allInputs = document.querySelectorAll('input[type="hidden"]');
            console.log(`üîç Available hidden inputs:`, Array.from(allInputs).map(inp => ({id: inp.id, name: inp.name})));
        }
        
        // Create safe URL from trusted filename - no external URL trusted
        const safeUrl = createSafeMediaUrl(filename, mediaType);
        if (safeUrl) {
            console.log(`üì∫ Showing preview for: ${safeUrl}`);
            showSelectedMediaPreview(safeUrl, mediaType);
        } else {
            console.error('Cannot create safe URL for', filename, mediaType);
        }
        
        // Update main content preview when media is selected
        updateMainContentPreview();
        
        // Clear file input since we're using existing file
        const fileInputId = mediaType === 'image' ? 'image_file' : 
                          mediaType === 'video' ? 'video_file' : 'audio_file';
        const fileInput = document.getElementById(fileInputId);
        if (fileInput) {
            fileInput.value = '';
        }
    }
    
    // Update main content preview with current form data
    function updateMainContentPreview() {
        const mainPreview = document.getElementById('mainContentPreview');
        const textPreview = document.getElementById('textContentPreview');
        
        if (!mainPreview || !textPreview) return;
        
        // Get current form values
        const mediaType = document.getElementById('mediaType')?.value || 'text';
        const title = document.getElementById('title')?.value || '';
        const content = document.getElementById('content')?.value || '';
        
        // Get selected media files
        const selectedImage = document.getElementById('selectedImageFile')?.value || '';
        const selectedVideo = document.getElementById('selectedVideoFile')?.value || '';
        const selectedAudio = document.getElementById('selectedAudioFile')?.value || '';
        
        // Clear main preview
        mainPreview.innerHTML = '';
        
        // Show media type indicator and selected media
        if (mediaType !== 'text') {
            let mediaIcon = '';
            let mediaLabel = '';
            let selectedFile = '';
            
            if (mediaType === 'image') {
                mediaIcon = 'üì∑';
                mediaLabel = 'Image Content';
                selectedFile = selectedImage;
            } else if (mediaType === 'video') {
                mediaIcon = 'üé¨';
                mediaLabel = 'Video Content';
                selectedFile = selectedVideo;
            } else if (mediaType === 'audio') {
                mediaIcon = 'üéµ';
                mediaLabel = 'Audio Content';
                selectedFile = selectedAudio;
            }
            
            // Create media header
            const mediaHeader = document.createElement('div');
            mediaHeader.className = 'alert alert-info mb-2';
            mediaHeader.innerHTML = `${mediaIcon} ${mediaLabel}`;
            mainPreview.appendChild(mediaHeader);
            
            // Show selected media if available
            if (selectedFile) {
                const mediaContainer = document.createElement('div');
                mediaContainer.className = 'mb-3';
                
                if (mediaType === 'image') {
                    mediaContainer.innerHTML = `<img src="${createSafeMediaUrl(selectedFile, 'image')}" class="img-fluid rounded" style="max-width: 400px;">`;
                } else if (mediaType === 'video') {
                    mediaContainer.innerHTML = `<video controls class="img-fluid rounded" style="max-width: 400px; width: 100%;">
                        <source src="${createSafeMediaUrl(selectedFile, 'video')}" type="video/mp4">
                        Your browser does not support the video element.
                    </video>`;
                } else if (mediaType === 'audio') {
                    mediaContainer.innerHTML = `<audio controls class="w-100" style="max-width: 400px;">
                        <source src="${createSafeMediaUrl(selectedFile, 'audio')}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>`;
                }
                
                mainPreview.appendChild(mediaContainer);
            }
            
            // Show title if available
            if (title.trim()) {
                const titleDiv = document.createElement('div');
                titleDiv.className = 'alert alert-secondary mb-2';
                titleDiv.innerHTML = `üìπ ${title}`;
                mainPreview.appendChild(titleDiv);
            }
        }
        
        // Update text content preview
        if (content.trim()) {
            textPreview.innerHTML = `<div class="border rounded p-3 bg-light">${content.replace(/\n/g, '<br>')}</div>`;
        } else {
            textPreview.innerHTML = '<p class="text-muted">No content text entered yet...</p>';
        }
    }
    
    // Show preview of selected media (expects already sanitized URL)
    function showSelectedMediaPreview(sanitizedUrl, mediaType) {
        // URL should already be sanitized by caller
        if (!sanitizedUrl) {
            console.error('No URL provided for preview');
            return;
        }
        
        if (mediaType === 'image') {
            const previewDiv = document.getElementById('selectedImagePreview');
            const previewImg = document.getElementById('selectedImagePreviewImg');
            if (previewDiv && previewImg) {
                previewImg.src = sanitizedUrl;
                previewDiv.style.display = 'block';
            }
            // Hide other previews
            const videoPreview = document.getElementById('selectedVideoPreview');
            const audioPreview = document.getElementById('selectedAudioPreview');
            if (videoPreview) videoPreview.style.display = 'none';
            if (audioPreview) audioPreview.style.display = 'none';
        } else if (mediaType === 'video') {
            const previewDiv = document.getElementById('selectedVideoPreview');
            const previewVid = document.getElementById('selectedVideoPreviewVid');
            if (previewDiv && previewVid) {
                previewVid.src = sanitizedUrl;
                previewDiv.style.display = 'block';
            }
            // Hide other previews
            const imagePreview = document.getElementById('selectedImagePreview');
            const audioPreview = document.getElementById('selectedAudioPreview');
            if (imagePreview) imagePreview.style.display = 'none';
            if (audioPreview) audioPreview.style.display = 'none';
        } else if (mediaType === 'audio') {
            const previewDiv = document.getElementById('selectedAudioPreview');
            const previewAud = document.getElementById('selectedAudioPreviewAud');
            if (previewDiv && previewAud) {
                previewAud.src = sanitizedUrl;
                previewDiv.style.display = 'block';
            }
            // Hide other previews
            const imagePreview = document.getElementById('selectedImagePreview');
            const videoPreview = document.getElementById('selectedVideoPreview');
            if (imagePreview) imagePreview.style.display = 'none';
            if (videoPreview) videoPreview.style.display = 'none';
        }
    }

    // Pre-populate hidden inputs with existing content values when editing
    {% if content %}
        {% if content.image_filename %}
            document.getElementById('selectedImageFile').value = '{{ content.image_filename }}';
            console.log('‚úÖ Pre-populated existing image: {{ content.image_filename }}');
        {% endif %}
        {% if content.video_filename %}
            document.getElementById('selectedVideoFile').value = '{{ content.video_filename }}';
            console.log('‚úÖ Pre-populated existing video: {{ content.video_filename }}');
        {% endif %}
        {% if content.audio_filename %}
            document.getElementById('selectedAudioFile').value = '{{ content.audio_filename }}';
            console.log('‚úÖ Pre-populated existing audio: {{ content.audio_filename }}');
        {% endif %}
    {% endif %}
    
    // Initialize main content preview on page load
    updateMainContentPreview();
    
    // Update main preview when content changes
    const contentTextarea = document.getElementById('content');
    if (contentTextarea) {
        contentTextarea.addEventListener('input', updateMainContentPreview);
    }
    
    // Update main preview when title changes  
    const titleInput = document.getElementById('title');
    if (titleInput) {
        titleInput.addEventListener('input', updateMainContentPreview);
    }
    
    // Update main preview when media type changes
    mediaTypeSelect.addEventListener('change', updateMainContentPreview);
    
    // Handle form submission to include selected files
    document.getElementById('contentForm').addEventListener('submit', function(e) {
        const selectedImage = document.getElementById('selectedImageFile');
        const selectedVideo = document.getElementById('selectedVideoFile');
        const selectedAudio = document.getElementById('selectedAudioFile');
        
        console.log('üì§ Form being submitted');
        console.log('üîç Form submit - checking selected media files:');
        console.log('üîç   selectedImage:', selectedImage ? selectedImage.value : 'not found');
        console.log('üîç   selectedVideo:', selectedVideo ? selectedVideo.value : 'not found');
        console.log('üîç   selectedAudio:', selectedAudio ? selectedAudio.value : 'not found');
        
        // Debug: Log all form data before submission
        const formData = new FormData(this);
        console.log('üîç Form data being submitted:');
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: "${value}"`);
        }
    });
    </script>
</body>
</html>