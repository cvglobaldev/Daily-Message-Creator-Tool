{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-photo-video me-2"></i>{{ title }}
                    </h4>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" enctype="multipart/form-data" id="contentForm">
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    {{ form.day_number.label(class="form-label") }}
                                    {{ form.day_number(class="form-control") }}
                                    {% if form.day_number.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.day_number.errors[0] }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div class="mb-3">
                                    {{ form.title.label(class="form-label") }}
                                    {{ form.title(class="form-control", placeholder="Enter a compelling title for this day's content") }}
                                    {% if form.title.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.title.errors[0] }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form.media_type.label(class="form-label") }}
                            {{ form.media_type(class="form-select", id="mediaType") }}
                            {% if form.media_type.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.media_type.errors[0] }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Image Upload Section -->
                        <div id="imageSection" class="mb-3" style="display: none;">
                            <div class="row">
                                <div class="col-md-12">
                                    {{ form.image_file.label(class="form-label") }}
                                    {{ form.image_file(class="form-control", accept="image/*") }}
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Supported formats: JPG, PNG, GIF (Max 16MB)
                                    </div>
                                    {% if content and content.image_filename %}
                                        <div class="mt-2">
                                            <small class="text-muted">Current image:</small><br>
                                            <img src="{{ url_for('uploaded_file', filename='images/' + content.image_filename) }}" 
                                                 class="img-thumbnail mt-1" style="max-width: 200px;">
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Video URL Section -->
                        <div id="videoSection" class="mb-3" style="display: none;">
                            {{ form.youtube_url.label(class="form-label") }}
                            {{ form.youtube_url(class="form-control", placeholder="https://www.youtube.com/watch?v=VIDEO_ID") }}
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Enter the full YouTube URL (e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ)
                            </div>
                            {% if form.youtube_url.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.youtube_url.errors[0] }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Audio Upload Section -->
                        <div id="audioSection" class="mb-3" style="display: none;">
                            {{ form.audio_file.label(class="form-label") }}
                            {{ form.audio_file(class="form-control", accept="audio/*") }}
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Supported formats: MP3, WAV, OGG, M4A (Max 16MB)
                            </div>
                            {% if content and content.audio_filename %}
                                <div class="mt-2">
                                    <small class="text-muted">Current audio:</small><br>
                                    <audio controls class="mt-1" style="max-width: 300px;">
                                        <source src="{{ url_for('uploaded_file', filename='audio/' + content.audio_filename) }}" type="audio/mpeg">
                                        Your browser does not support the audio element.
                                    </audio>
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.content.label(class="form-label") }}
                            {{ form.content(class="form-control", rows="6", 
                               placeholder="Enter the main content for this day. This will be sent to users along with any multimedia content.") }}
                            {% if form.content.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.content.errors[0] }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.reflection_question.label(class="form-label") }}
                            {{ form.reflection_question(class="form-control", rows="3", 
                               placeholder="Enter a thoughtful reflection question that will be sent after the main content.") }}
                            {% if form.reflection_question.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.reflection_question.errors[0] }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.tags.label(class="form-label") }}
                            {{ form.tags(class="form-control", 
                               placeholder="Bible Exposure, Christian Learning, Prayer, Gospel Presentation") }}
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Available tags: Bible Exposure, Christian Learning, Bible Engagement, Salvation Prayer, 
                                Gospel Presentation, Prayer, Introduction to Jesus, Holy Spirit Empowerment
                            </div>
                            {% if form.tags.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.tags.errors[0] }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.is_active(class="form-check-input") }}
                                {{ form.is_active.label(class="form-check-label") }}
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('content_list') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to List
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>{{ "Update Content" if content else "Create Content" }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Preview Section -->
            {% if content %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-eye me-2"></i>Content Preview</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Text Content:</h6>
                            <div class="border rounded p-3 bg-light">
                                {{ content.content }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            {% if content.media_type == 'image' and content.image_filename %}
                                <h6>Image:</h6>
                                <img src="{{ url_for('uploaded_file', filename='images/' + content.image_filename) }}" 
                                     class="img-fluid rounded" style="max-height: 200px;">
                            {% elif content.media_type == 'video' and content.youtube_url %}
                                <h6>Video:</h6>
                                {% set video_id = content.youtube_url.split('v=')[1].split('&')[0] if 'v=' in content.youtube_url %}
                                {% if video_id %}
                                    <div class="ratio ratio-16x9">
                                        <iframe src="https://www.youtube.com/embed/{{ video_id }}" 
                                                allowfullscreen></iframe>
                                    </div>
                                {% endif %}
                            {% elif content.media_type == 'audio' and content.audio_filename %}
                                <h6>Audio:</h6>
                                <audio controls class="w-100">
                                    <source src="{{ url_for('uploaded_file', filename='audio/' + content.audio_filename) }}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if content.reflection_question %}
                        <div class="mt-3">
                            <h6>Reflection Question:</h6>
                            <div class="border rounded p-3 bg-light">
                                <em>{{ content.reflection_question }}</em>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const mediaTypeSelect = document.getElementById('mediaType');
    const imageSection = document.getElementById('imageSection');
    const videoSection = document.getElementById('videoSection');
    const audioSection = document.getElementById('audioSection');
    
    function toggleSections() {
        const selectedType = mediaTypeSelect.value;
        
        imageSection.style.display = selectedType === 'image' ? 'block' : 'none';
        videoSection.style.display = selectedType === 'video' ? 'block' : 'none';
        audioSection.style.display = selectedType === 'audio' ? 'block' : 'none';
    }
    
    mediaTypeSelect.addEventListener('change', toggleSections);
    toggleSections(); // Initialize on page load
});
</script>
{% endblock %}