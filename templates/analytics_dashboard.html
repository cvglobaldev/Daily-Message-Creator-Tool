
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Faith Journey</title>
    
    <!-- CV Global Favicon Implementation -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="256x256" href="/static/favicon/favicon-256x256.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon/apple-touch-icon.png">
    <link rel="shortcut icon" href="/static/favicon.ico">
    <meta name="theme-color" content="#00ff88">
    
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/cvglobal-theme.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="/static/favicon/cv-new-logo-favicon-32px.png" alt="CV Global Logo" class="me-2" style="width: 24px; height: 24px;">
                Analytics Dashboard
            </a>
            <div class="navbar-nav flex-row">
                <a class="nav-link me-3" href="/dashboard"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a>
                <a class="nav-link me-3" href="/bots"><i class="fas fa-robot me-1"></i>Bots</a>
                <a class="nav-link me-3" href="/chat-management"><i class="fas fa-comments me-1"></i>Chat</a>
                <a class="nav-link me-3 active" href="/analytics"><i class="fas fa-chart-line me-1"></i>Analytics</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Bot</label>
                        <select class="form-select" id="botFilter">
                            <option value="">All Bots</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Time Range</label>
                        <select class="form-select" id="timeRangeFilter">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="60">Last 60 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div class="col-md-3" id="customDateRange" style="display: none;">
                        <label class="form-label">Custom Date</label>
                        <input type="date" class="form-control" id="customDate">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="loadAnalytics()">
                            <i class="fas fa-sync me-1"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 1: User Journey Analytics -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-route me-2"></i>User Journey Analytics</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Journey Completion Funnel</h6>
                        <canvas id="journeyFunnelChart"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h6>Drop-off Rate by Day</h6>
                        <canvas id="dropoffChart"></canvas>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="text-center">
                            <h3 id="avgDaysToCompletion">-</h3>
                            <p class="text-muted">Average Days to Completion</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: Faith Journey Insights -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cross me-2"></i>Faith Journey Insights</h5>
            </div>
            <div class="card-body">
                <!-- Summary Stats -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 id="totalUsers" class="text-primary">-</h3>
                            <p class="text-muted mb-0">Total Users</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 id="totalFaithJourneys" class="text-success">-</h3>
                            <p class="text-muted mb-0">Total Faith Journeys</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 id="completionRate" class="text-warning">-</h3>
                            <p class="text-muted mb-0">Completion Rate %</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 id="avgJourneyDay" class="text-info">-</h3>
                            <p class="text-muted mb-0">Avg Journey Day</p>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="row">
                    <div class="col-md-6">
                        <h6>Faith Journey Tag Distribution</h6>
                        <canvas id="tagDistributionChart"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h6>Tag Count & Percentage</h6>
                        <div id="tagStatsTable" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Tag</th>
                                        <th>Count</th>
                                        <th>Percentage</th>
                                    </tr>
                                </thead>
                                <tbody id="tagStatsBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tag Timeline -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h6>When Users Receive Tags (by Journey Day)</h6>
                        <canvas id="tagTimelineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let charts = {};

        // Load bots for filter
        async function loadBots() {
            const response = await fetch('/api/bots');
            const bots = await response.json();
            const select = document.getElementById('botFilter');
            bots.forEach(bot => {
                const option = document.createElement('option');
                option.value = bot.id;
                option.textContent = bot.name;
                select.appendChild(option);
            });
        }

        // Show/hide custom date range
        document.getElementById('timeRangeFilter').addEventListener('change', function() {
            const customRange = document.getElementById('customDateRange');
            customRange.style.display = this.value === 'custom' ? 'block' : 'none';
        });

        // Load analytics data
        async function loadAnalytics() {
            const botId = document.getElementById('botFilter').value;
            const timeRange = document.getElementById('timeRangeFilter').value;
            const customDate = document.getElementById('customDate').value;

            const params = new URLSearchParams();
            if (botId) params.append('bot_id', botId);
            if (timeRange === 'custom' && customDate) {
                params.append('custom_date', customDate);
            } else {
                params.append('days', timeRange);
            }

            // Load User Journey Analytics
            const journeyResponse = await fetch(`/api/analytics/user-journey?${params}`);
            const journeyData = await journeyResponse.json();
            renderUserJourneyAnalytics(journeyData);

            // Load Faith Journey Insights
            const faithResponse = await fetch(`/api/analytics/faith-journey?${params}`);
            const faithData = await faithResponse.json();
            renderFaithJourneyInsights(faithData);
        }

        function renderUserJourneyAnalytics(data) {
            // Journey Funnel Chart
            if (charts.funnelChart) charts.funnelChart.destroy();
            const funnelCtx = document.getElementById('journeyFunnelChart').getContext('2d');
            charts.funnelChart = new Chart(funnelCtx, {
                type: 'bar',
                data: {
                    labels: data.funnel.labels,
                    datasets: [{
                        label: 'Users',
                        data: data.funnel.values,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });

            // Drop-off Chart
            if (charts.dropoffChart) charts.dropoffChart.destroy();
            const dropoffCtx = document.getElementById('dropoffChart').getContext('2d');
            charts.dropoffChart = new Chart(dropoffCtx, {
                type: 'line',
                data: {
                    labels: data.dropoff.days,
                    datasets: [{
                        label: 'Drop-off Rate %',
                        data: data.dropoff.rates,
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });

            // Average Days to Completion
            document.getElementById('avgDaysToCompletion').textContent = data.avg_days_to_completion.toFixed(1);
        }

        function renderFaithJourneyInsights(data) {
            // Summary Stats
            document.getElementById('totalUsers').textContent = data.total_users;
            document.getElementById('totalFaithJourneys').textContent = data.total_faith_journeys;
            document.getElementById('completionRate').textContent = data.completion_rate.toFixed(1) + '%';
            document.getElementById('avgJourneyDay').textContent = data.avg_journey_day.toFixed(1);

            // Tag Distribution Pie Chart
            if (charts.tagPieChart) charts.tagPieChart.destroy();
            const pieCtx = document.getElementById('tagDistributionChart').getContext('2d');
            charts.tagPieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: data.tag_distribution.labels,
                    datasets: [{
                        data: data.tag_distribution.values,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)',
                            'rgba(199, 199, 199, 0.8)',
                            'rgba(83, 102, 255, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });

            // Tag Stats Table
            const tbody = document.getElementById('tagStatsBody');
            tbody.innerHTML = '';
            data.tag_stats.forEach(stat => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${stat.tag}</td>
                    <td>${stat.count}</td>
                    <td>${stat.percentage.toFixed(1)}%</td>
                `;
            });

            // Tag Timeline Chart
            if (charts.tagTimelineChart) charts.tagTimelineChart.destroy();
            const timelineCtx = document.getElementById('tagTimelineChart').getContext('2d');
            const datasets = data.tag_timeline.tags.map((tag, index) => ({
                label: tag,
                data: data.tag_timeline.data[tag],
                borderColor: `hsl(${index * 40}, 70%, 50%)`,
                backgroundColor: `hsla(${index * 40}, 70%, 50%, 0.1)`,
                borderWidth: 2,
                tension: 0.4
            }));

            charts.tagTimelineChart = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: data.tag_timeline.days,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Number of Users' } },
                        x: { title: { display: true, text: 'Journey Day' } }
                    },
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        }

        // Initialize
        loadBots();
        loadAnalytics();
    </script>
</body>
</html>
